–í—ã –ø—Ä–æ–¥–µ–ª–∞–ª–∏ –ø—Ä–æ—Å—Ç–æ —Ç–∏—Ç–∞–Ω–∏—á–µ—Å–∫—É—é —Ä–∞–±–æ—Ç—É –ø–æ –∞–Ω–∞–ª–∏–∑—É –∏ –ø—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—é. –í–∞—à–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω–æ–µ –¢–ó ‚Äî —ç—Ç–æ –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏ –≥–æ—Ç–æ–≤—ã–π –¥–æ–∫—É–º–µ–Ω—Ç –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏. –°—Ç—Ä—É–∫—Ç—É—Ä–∞, —Ä–æ–ª–∏, –ª–æ–≥–∏–∫–∞ ‚Äî –≤—Å—ë –Ω–∞ –≤—ã—Å—à–µ–º —É—Ä–æ–≤–Ω–µ. –≠—Ç–æ —Å–∏–ª—å–Ω–æ —É–ø—Ä–æ—â–∞–µ—Ç –∑–∞–¥–∞—á—É.

–ö–∞–∫ –≤—ã –ø—Ä–∞–≤–∏–ª—å–Ω–æ –ø–æ–Ω—è–ª–∏, –Ω–∞–ø–∏—Å–∞—Ç—å –≤—Å—ë –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Ü–µ–ª–∏–∫–æ–º –≤ –æ–¥–Ω–æ–º –æ—Ç–≤–µ—Ç–µ –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ. –ü–æ—ç—Ç–æ–º—É —è —Å–¥–µ–ª–∞—é —Ç–æ, —á—Ç–æ –ø—Ä–∏–Ω–µ—Å—ë—Ç –º–∞–∫—Å–∏–º—É–º –ø–æ–ª—å–∑—ã –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å:

1. **–ù–∞–ø–∏—à—É —Ñ–∏–Ω–∞–ª—å–Ω—É—é, –≥–æ—Ç–æ–≤—É—é –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –Ω–∞ PostgreSQL.** –Ø –≤–æ–∑—å–º—É –≤–∞—à—É —Å—Ö–µ–º—É –∑–∞ –æ—Å–Ω–æ–≤—É, –≤–Ω–µ—Å—É –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–µ –¥–æ—Ä–∞–±–æ—Ç–∫–∏ –¥–ª—è –Ω–∞–¥—ë–∂–Ω–æ—Å—Ç–∏ –∏ –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç–∏ –∏ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—é –≥–æ—Ç–æ–≤—ã–π SQL-—Å–∫—Ä–∏–ø—Ç.
    
2. **–†–∞–∑—Ä–∞–±–æ—Ç–∞—é –∏ –æ–ø–∏—à—É –ø—Ä–∞–≤–∏–ª—å–Ω—É—é –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É –∏ —Ñ–∞–π–ª–æ–≤—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É –ø—Ä–æ–µ–∫—Ç–∞.** –≠—Ç–æ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω–æ, —á—Ç–æ–±—ã –ø—Ä–æ–µ–∫—Ç –Ω–µ –ø—Ä–µ–≤—Ä–∞—Ç–∏–ª—Å—è –≤ —Ö–∞–æ—Å –∏ –µ–≥–æ –±—ã–ª–æ –ª–µ–≥–∫–æ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å –∏ —Ä–∞—Å—à–∏—Ä—è—Ç—å.
    
3. **–ù–∞–ø–∏—à—É —Å—Ç–∞—Ä—Ç–æ–≤—ã–π –∫–æ–¥ –Ω–∞ Python** —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –±–∏–±–ª–∏–æ—Ç–µ–∫ (aiogram 3, SQLAlchemy). –≠—Ç–æ—Ç –∫–æ–¥ –±—É–¥–µ—Ç –≤–∫–ª—é—á–∞—Ç—å –±–∞–∑–æ–≤—É—é –ª–æ–≥–∏–∫—É (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø—Ä–∏ –∫–æ–º–∞–Ω–¥–µ /start) –∏ –ø–æ–∫–∞–∂–µ—Ç, –∫–∞–∫ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–æ–≤–∞—Ç—å —Å —Å–æ–∑–¥–∞–Ω–Ω–æ–π –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö –≤ —Ä–∞–º–∫–∞—Ö –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–Ω–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã.
    

–≠—Ç–æ –±—É–¥–µ—Ç –ø—Ä–æ—á–Ω—ã–π —Ñ—É–Ω–¥–∞–º–µ–Ω—Ç, –Ω–∞ –∫–æ—Ç–æ—Ä–æ–º –≤—ã —Å–º–æ–∂–µ—Ç–µ –ø–æ—Å—Ç—Ä–æ–∏—Ç—å –≤—Å—ë –æ—Å—Ç–∞–ª—å–Ω–æ–µ.

---

### 1. –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –ë–∞–∑—ã –î–∞–Ω–Ω—ã—Ö (PostgreSQL)

–í–∞—à–∞ —Å—Ö–µ–º–∞ –æ—Ç–ª–∏—á–Ω–∞—è. –Ø –µ—ë –¥–æ—Ä–∞–±–æ—Ç–∞–ª, —á—Ç–æ–±—ã –æ–Ω–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–æ–≤–∞–ª–∞ –ª—É—á—à–∏–º –ø—Ä–∞–∫—Ç–∏–∫–∞–º: –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª –±–æ–ª–µ–µ –ø–æ–¥—Ö–æ–¥—è—â–∏–µ —Ç–∏–ø—ã –¥–∞–Ω–Ω—ã—Ö, –¥–æ–±–∞–≤–∏–ª –∫–∞—Å–∫–∞–¥–Ω–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ, –∏–Ω–¥–µ–∫—Å—ã –¥–ª—è —É—Å–∫–æ—Ä–µ–Ω–∏—è –ø–æ–∏—Å–∫–∞ –∏ –ø—Ä–∏–º–µ–Ω–∏–ª UUID –≤ –∫–∞—á–µ—Å—Ç–≤–µ –ø–µ—Ä–≤–∏—á–Ω—ã—Ö –∫–ª—é—á–µ–π –¥–ª—è –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–∞ —Å—É—â–Ω–æ—Å—Ç–µ–π ‚Äî —ç—Ç–æ —É—Å–ª–æ–∂–Ω—è–µ—Ç –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–µ ID –∏ –ø–æ–º–æ–≥–∞–µ—Ç –ø—Ä–∏ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–∏.

–í–æ—Ç –≥–æ—Ç–æ–≤—ã–π SQL-—Å–∫—Ä–∏–ø—Ç. –ü—Ä–æ—Å—Ç–æ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ –µ–≥–æ –≤ –≤–∞—à–µ–π –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö, –∏ –≤—Å–µ —Ç–∞–±–ª–∏—Ü—ã –±—É–¥—É—Ç —Å–æ–∑–¥–∞–Ω—ã.

      `-- –í–∫–ª—é—á–∞–µ–º —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ UUID
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";

-- 1. –¢–∞–±–ª–∏—Ü–∞ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ (Users)
CREATE TABLE Users (
    telegram_id BIGINT PRIMARY KEY,
    telegram_username VARCHAR(255) NULL,
    first_name VARCHAR(255) NOT NULL,
    last_name VARCHAR(255) NULL,
    middle_name VARCHAR(255) NULL,
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    last_active_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    notification_settings JSONB NULL -- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON
);

-- 2. –¢–∞–±–ª–∏—Ü–∞ –ì—Ä—É–ø–ø—ã (Groups)
CREATE TABLE Groups (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    name VARCHAR(255) NOT NULL,
    description TEXT NULL,
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    creator_id BIGINT REFERENCES Users(telegram_id) ON DELETE SET NULL
);

-- 3. –¢–∞–±–ª–∏—Ü–∞ –£—á–∞—Å—Ç–Ω–∏–∫–∏ –≥—Ä—É–ø–ø (GroupMembers)
CREATE TABLE GroupMembers (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    user_id BIGINT NOT NULL REFERENCES Users(telegram_id) ON DELETE CASCADE,
    group_id UUID NOT NULL REFERENCES Groups(id) ON DELETE CASCADE,
    is_leader BOOLEAN NOT NULL DEFAULT FALSE,
    is_assistant BOOLEAN NOT NULL DEFAULT FALSE,
    joined_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    UNIQUE(user_id) -- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç —Å–æ—Å—Ç–æ—è—Ç—å —Ç–æ–ª—å–∫–æ –≤ –æ–¥–Ω–æ–π –≥—Ä—É–ø–ø–µ
);
CREATE INDEX idx_groupmembers_group_id ON GroupMembers(group_id);

-- 4. –¢–∞–±–ª–∏—Ü–∞ –ü—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è –≤ –≥—Ä—É–ø–ø—ã (GroupInvitations)
CREATE TABLE GroupInvitations (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    group_id UUID NOT NULL REFERENCES Groups(id) ON DELETE CASCADE,
    invited_by_user_id BIGINT NOT NULL REFERENCES Users(telegram_id) ON DELETE CASCADE,
    invite_token VARCHAR(32) NOT NULL UNIQUE,
    expires_at TIMESTAMPTZ NOT NULL,
    is_used BOOLEAN NOT NULL DEFAULT FALSE,
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);
CREATE INDEX idx_groupinvitations_token ON GroupInvitations(invite_token);

-- 5. –¢–∞–±–ª–∏—Ü–∞ –°–æ–±—ã—Ç–∏—è (Events)
CREATE TABLE Events (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    group_id UUID NOT NULL REFERENCES Groups(id) ON DELETE CASCADE,
    created_by_user_id BIGINT NOT NULL REFERENCES Users(telegram_id) ON DELETE SET NULL,
    title VARCHAR(255) NOT NULL,
    description TEXT NULL,
    subject VARCHAR(255) NULL,
    event_date DATE NOT NULL,
    is_important BOOLEAN NOT NULL DEFAULT FALSE,
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);
CREATE INDEX idx_events_group_id_date ON Events(group_id, event_date);

-- 6. –¢–∞–±–ª–∏—Ü–∞ –ü—Ä–æ—Å–º–æ—Ç—Ä–µ–Ω–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è (ViewedEvents)
CREATE TABLE ViewedEvents (
    user_id BIGINT NOT NULL REFERENCES Users(telegram_id) ON DELETE CASCADE,
    event_id UUID NOT NULL REFERENCES Events(id) ON DELETE CASCADE,
    viewed_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    PRIMARY KEY (user_id, event_id)
);

-- 7. –¢–∞–±–ª–∏—Ü–∞ –î–µ–¥–ª–∞–π–Ω—ã (Deadlines)
CREATE TABLE Deadlines (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    event_id UUID NOT NULL REFERENCES Events(id) ON DELETE CASCADE,
    description TEXT NULL,
    deadline_at TIMESTAMPTZ NOT NULL
);

-- 8. –¢–∞–±–ª–∏—Ü–∞ –û—á–µ—Ä–µ–¥–∏ (Queues)
CREATE TABLE Queues (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    event_id UUID NOT NULL REFERENCES Events(id) ON DELETE CASCADE,
    title VARCHAR(255) NOT NULL,
    description TEXT NULL,
    max_participants INT NULL,
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- 9. –¢–∞–±–ª–∏—Ü–∞ –£—á–∞—Å—Ç–Ω–∏–∫–∏ –æ—á–µ—Ä–µ–¥–µ–π (QueueParticipants)
CREATE TABLE QueueParticipants (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    queue_id UUID NOT NULL REFERENCES Queues(id) ON DELETE CASCADE,
    user_id BIGINT NOT NULL REFERENCES Users(telegram_id) ON DELETE CASCADE,
    position INT NOT NULL,
    joined_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    UNIQUE(queue_id, user_id),
    UNIQUE(queue_id, position)
);

-- 10. –¢–∞–±–ª–∏—Ü–∞ –°–ø–∏—Å–∫–∏ —Ç–µ–º (TopicLists)
CREATE TABLE TopicLists (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    event_id UUID NOT NULL REFERENCES Events(id) ON DELETE CASCADE,
    title VARCHAR(255) NOT NULL,
    max_participants_per_topic INT NOT NULL,
    created_by_user_id BIGINT NOT NULL REFERENCES Users(telegram_id) ON DELETE SET NULL,
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- 11. –¢–∞–±–ª–∏—Ü–∞ –¢–µ–º—ã (Topics)
CREATE TABLE Topics (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    topic_list_id UUID NOT NULL REFERENCES TopicLists(id) ON DELETE CASCADE,
    title VARCHAR(255) NOT NULL,
    description TEXT NULL
);

-- 12. –¢–∞–±–ª–∏—Ü–∞ –í—ã–±–æ—Ä —Ç–µ–º (TopicSelections)
CREATE TABLE TopicSelections (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    topic_id UUID NOT NULL REFERENCES Topics(id) ON DELETE CASCADE,
    user_id BIGINT NOT NULL REFERENCES Users(telegram_id) ON DELETE CASCADE,
    selected_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    is_confirmed BOOLEAN NOT NULL DEFAULT FALSE,
    confirmed_by_user_id BIGINT NULL REFERENCES Users(telegram_id) ON DELETE SET NULL,
    UNIQUE(topic_id, user_id)
);

-- 13. –¢–∞–±–ª–∏—Ü–∞ –ö–æ–¥—ã –¥–æ—Å—Ç—É–ø–∞ –¥–ª—è –∞–¥–º–∏–Ω–æ–≤ (AdminAccessCodes)
CREATE TABLE AdminAccessCodes (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    code VARCHAR(64) NOT NULL UNIQUE,
    is_one_time BOOLEAN NOT NULL DEFAULT TRUE,
    expires_at TIMESTAMPTZ,
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    is_active BOOLEAN NOT NULL DEFAULT TRUE
);

-- 14. –¢–∞–±–ª–∏—Ü–∞ –õ–æ–≥–∏ (ChangeLog)
CREATE TABLE ChangeLog (
    id BIGSERIAL PRIMARY KEY,
    user_id BIGINT REFERENCES Users(telegram_id) ON DELETE SET NULL,
    action_type VARCHAR(50) NOT NULL,
    details JSONB NULL,
    entity_type VARCHAR(50) NULL,
    entity_id VARCHAR(255) NULL,
    changed_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);
`
    

IGNORE_WHEN_COPYING_START

Use code [with caution](https://support.google.com/legal/answer/13505487). SQL

IGNORE_WHEN_COPYING_END

---

### 2. –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∏ –§–∞–π–ª–æ–≤–∞—è –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ü—Ä–æ–µ–∫—Ç–∞

–î–ª—è —Ç–∞–∫–æ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞ –∏–¥–µ–∞–ª—å–Ω–æ –ø–æ–¥–æ–π–¥–µ—Ç Python, –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ aiogram 3, SQLAlchemy –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ë–î –∏ Alembic –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –º–∏–≥—Ä–∞—Ü–∏—è–º–∏ (–∏–∑–º–µ–Ω–µ–Ω–∏—è–º–∏) —Å—Ö–µ–º—ã –ë–î.

      `/study_group_bot ‚îú‚îÄ‚îÄ .env                  # –§–∞–π–ª —Å —Å–µ–∫—Ä–µ—Ç–∞–º–∏ (—Ç–æ–∫–µ–Ω –±–æ—Ç–∞, –¥–∞–Ω–Ω—ã–µ –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –ë–î) ‚îú‚îÄ‚îÄ requirements.txt      # –°–ø–∏—Å–æ–∫ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π Python ‚îú‚îÄ‚îÄ bot.py                # –ì–ª–∞–≤–Ω—ã–π —Ñ–∞–π–ª –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –±–æ—Ç–∞ ‚îÇ ‚îî‚îÄ‚îÄ app/     ‚îú‚îÄ‚îÄ __init__.py     ‚îÇ     ‚îú‚îÄ‚îÄ config.py             # –ß—Ç–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –∏–∑ .env —Ñ–∞–π–ª–∞     ‚îÇ     ‚îú‚îÄ‚îÄ handlers/             # –ó–¥–µ—Å—å –±—É–¥–µ—Ç –≤—Å—è –ª–æ–≥–∏–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è     ‚îÇ   ‚îú‚îÄ‚îÄ __init__.py     ‚îÇ   ‚îú‚îÄ‚îÄ common.py         # –û–±—â–∏–µ –∫–æ–º–∞–Ω–¥—ã (start, help) –∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è     ‚îÇ   ‚îú‚îÄ‚îÄ admin.py          # –•—ç–Ω–¥–ª–µ—Ä—ã –¥–ª—è –∞–¥–º–∏–Ω–æ–≤     ‚îÇ   ‚îú‚îÄ‚îÄ group_leader.py   # –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª —Å—Ç–∞—Ä–æ—Å—Ç—ã     ‚îÇ   ‚îú‚îÄ‚îÄ group_assistant.py# –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª –ø–æ–º–æ—â–Ω–∏–∫–∞     ‚îÇ   ‚îî‚îÄ‚îÄ group_member.py   # –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª –æ–±—ã—á–Ω–æ–≥–æ —É—á–∞—Å—Ç–Ω–∏–∫–∞ (–∫–∞–ª–µ–Ω–¥–∞—Ä—å, —Ç–µ–º—ã)     ‚îÇ     ‚îú‚îÄ‚îÄ keyboards/            # –ú–æ–¥—É–ª–∏ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è Telegram-–∫–ª–∞–≤–∏–∞—Ç—É—Ä     ‚îÇ   ‚îú‚îÄ‚îÄ __init__.py     ‚îÇ   ‚îú‚îÄ‚îÄ inline.py         # –ö–Ω–æ–ø–∫–∏ –ø–æ–¥ —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏     ‚îÇ   ‚îî‚îÄ‚îÄ reply.py          # –ö–Ω–æ–ø–∫–∏ –≤–º–µ—Å—Ç–æ –æ–±—ã—á–Ω–æ–π –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã     ‚îÇ     ‚îú‚îÄ‚îÄ middlewares/          # –ü—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω–æ–µ –ü–û (–ø—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏, —Å–µ—Å—Å–∏—è –ë–î)     ‚îÇ   ‚îú‚îÄ‚îÄ __init__.py     ‚îÇ   ‚îî‚îÄ‚îÄ db.py     ‚îÇ     ‚îú‚îÄ‚îÄ db/                   # –í—Å–µ, —á—Ç–æ —Å–≤—è–∑–∞–Ω–æ —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö     ‚îÇ   ‚îú‚îÄ‚îÄ __init__.py     ‚îÇ   ‚îú‚îÄ‚îÄ models.py         # SQLAlchemy –º–æ–¥–µ–ª–∏ (–æ–ø–∏—Å–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü –≤ –≤–∏–¥–µ Python –∫–ª–∞—Å—Å–æ–≤)     ‚îÇ   ‚îî‚îÄ‚îÄ repository.py     # –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ë–î (–¥–æ–±–∞–≤–∏—Ç—å —é–∑–µ—Ä–∞, —Å–æ–∑–¥–∞—Ç—å –≥—Ä—É–ø–ø—É)     ‚îÇ     ‚îî‚îÄ‚îÄ utils/                # –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ (–≥–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç–æ–∫–µ–Ω–æ–≤ –∏ —Ç.–¥.)         ‚îú‚îÄ‚îÄ __init__.py         ‚îî‚îÄ‚îÄ tools.py`
    

IGNORE_WHEN_COPYING_START

Use code [with caution](https://support.google.com/legal/answer/13505487).

IGNORE_WHEN_COPYING_END

---

### 3. –°—Ç–∞—Ä—Ç–æ–≤—ã–π –ö–æ–¥ (Python, aiogram 3)

–≠—Ç–æ –ø—Ä–∏–º–µ—Ä —Ç–æ–≥–æ, –∫–∞–∫ –º–æ–∂–µ—Ç –≤—ã–≥–ª—è–¥–µ—Ç—å –Ω–∞—á–∞–ª–æ –≤–∞—à–µ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞. –û–Ω –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç, –∫–∞–∫ —Å–≤—è–∑–∞—Ç—å –≤—Å–µ —á–∞—Å—Ç–∏ –≤–º–µ—Å—Ç–µ.

**1. –§–∞–π–ª requirements.txt:**

      `aiogram==3.2.0 sqlalchemy[asyncio]==2.0.23 asyncpg==0.29.0 alembic==1.13.0 python-dotenv==1.0.0`
    

IGNORE_WHEN_COPYING_START

Use code [with caution](https://support.google.com/legal/answer/13505487).

IGNORE_WHEN_COPYING_END

**2. –§–∞–π–ª .env (—Ä—è–¥–æ–º —Å bot.py):**

      `BOT_TOKEN=–í–ê–®_–¢–û–ö–ï–ù_–ó–î–ï–°–¨ DATABASE_URL=postgresql+asyncpg://user:password@host:port/dbname`
    

IGNORE_WHEN_COPYING_START

Use code [with caution](https://support.google.com/legal/answer/13505487).

IGNORE_WHEN_COPYING_END

**3. –§–∞–π–ª app/db/models.py (–æ–ø–∏—à–µ–º –º–æ–¥–µ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –ø—Ä–∏–º–µ—Ä–∞):**

      `from sqlalchemy import BigInteger, String, Column, DateTime, func, JSONB from sqlalchemy.orm import DeclarativeBase  class Base(DeclarativeBase):     pass  class User(Base):     __tablename__ = 'users'      telegram_id = Column(BigInteger, primary_key=True)     telegram_username = Column(String, nullable=True)     first_name = Column(String, nullable=False)     last_name = Column(String, nullable=True)     middle_name = Column(String, nullable=True)     created_at = Column(DateTime(timezone=True), server_default=func.now())     last_active_at = Column(DateTime(timezone=True), server_default=func.now(), onupdate=func.now())     notification_settings = Column(JSONB, nullable=True)      def __repr__(self):         return f"<User(id={self.telegram_id}, name='{self.first_name}')>"  # ... –∑–¥–µ—Å—å –±—É–¥—É—Ç –æ–ø–∏—Å–∞–Ω—ã –æ—Å—Ç–∞–ª—å–Ω—ã–µ –º–æ–¥–µ–ª–∏ –∏–∑ SQL —Å–∫—Ä–∏–ø—Ç–∞ ...`
    

IGNORE_WHEN_COPYING_START

Use code [with caution](https://support.google.com/legal/answer/13505487). Python

IGNORE_WHEN_COPYING_END

**4. –§–∞–π–ª app/handlers/common.py (–æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /start –∏ –±–∞–∑–æ–≤–æ–π —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏):**

      `from aiogram import Router from aiogram.types import Message from aiogram.filters import CommandStart from sqlalchemy.ext.asyncio import AsyncSession from sqlalchemy.future import select  from app.db.models import User  router = Router()  @router.message(CommandStart()) async def cmd_start(message: Message, session: AsyncSession):     # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤ –±–∞–∑–µ     user_stmt = await session.execute(select(User).where(User.telegram_id == message.from_user.id))     user = user_stmt.scalar_one_or_none()      if not user:         # –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ—Ç, —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –µ–≥–æ         new_user = User(             telegram_id=message.from_user.id,             telegram_username=message.from_user.username,             first_name=message.from_user.first_name,             last_name=message.from_user.last_name         )         session.add(new_user)         await session.commit()         await message.answer(             "üëã –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å! –í—ã —É—Å–ø–µ—à–Ω–æ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã.\n\n"             "–¢–µ–ø–µ—Ä—å –≤—ã –º–æ–∂–µ—Ç–µ:\n"             "üîπ –°–æ–∑–¥–∞—Ç—å —Å–≤–æ—é –≥—Ä—É–ø–ø—É –∏ —Å—Ç–∞—Ç—å –µ—ë —Å—Ç–∞—Ä–æ—Å—Ç–æ–π\n"             "üîπ –ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è –∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π –≥—Ä—É–ø–ø–µ –ø–æ —Å—Å—ã–ª–∫–µ-–ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—é"         )     else:         # –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ –µ—Å—Ç—å, –ø—Ä–æ—Å—Ç–æ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤—É–µ–º         # –í –±—É–¥—É—â–µ–º –∑–¥–µ—Å—å –±—É–¥–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∞, —Å–æ—Å—Ç–æ–∏—Ç –ª–∏ –æ–Ω –≤ –≥—Ä—É–ø–ø–µ, –∏ –ø–æ–∫–∞–∑ –≥–ª–∞–≤–Ω–æ–≥–æ –º–µ–Ω—é         await message.answer(f"–° –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∏–µ–º, {message.from_user.first_name}!")`
    

IGNORE_WHEN_COPYING_START

Use code [with caution](https://support.google.com/legal/answer/13505487). Python

IGNORE_WHEN_COPYING_END

**5. –§–∞–π–ª bot.py (–≥–ª–∞–≤–Ω—ã–π —Ñ–∞–π–ª –¥–ª—è –∑–∞–ø—É—Å–∫–∞):**

      `import asyncio import logging from os import getenv  from aiogram import Bot, Dispatcher from aiogram.fsm.storage.memory import MemoryStorage from dotenv import load_dotenv from sqlalchemy.ext.asyncio import create_async_engine, async_sessionmaker  # –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –Ω–∞—à–∏ —Ä–æ—É—Ç–µ—Ä—ã from app.handlers import common from app.middlewares.db import DbSessionMiddleware  # –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –∏–∑ .env load_dotenv()  # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è logging.basicConfig(level=logging.INFO, format='%(asctime)s - %(levelname)s - %(name)s - %(message)s') logger = logging.getLogger(__name__)  async def main():     logger.info("Starting bot...")      # –°–æ–∑–¥–∞–µ–º –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –¥–≤–∏–∂–æ–∫ –¥–ª—è SQLAlchemy     engine = create_async_engine(getenv("DATABASE_URL"), echo=False) # echo=True –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏ SQL-–∑–∞–ø—Ä–æ—Å–æ–≤          # –°–æ–∑–¥–∞–µ–º —Ñ–∞–±—Ä–∏–∫—É —Å–µ—Å—Å–∏–π     session_maker = async_sessionmaker(engine, expire_on_commit=False)      # –°–æ–∑–¥–∞–µ–º –æ–±—ä–µ–∫—Ç—ã –ë–æ—Ç–∞ –∏ –î–∏—Å–ø–µ—Ç—á–µ—Ä–∞     bot = Bot(token=getenv("BOT_TOKEN"))     dp = Dispatcher(storage=MemoryStorage())      # –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º middleware –¥–ª—è –ø–µ—Ä–µ–¥–∞—á–∏ —Å–µ—Å—Å–∏–∏ –≤ —Ö—ç–Ω–¥–ª–µ—Ä—ã     dp.update.middleware(DbSessionMiddleware(session_pool=session_maker))      # –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º —Ä–æ—É—Ç–µ—Ä—ã     dp.include_router(common.router)     # dp.include_router(group_leader.router) # <- —Ç–∞–∫ –≤—ã –±—É–¥–µ—Ç–µ –¥–æ–±–∞–≤–ª—è—Ç—å –Ω–æ–≤—ã–µ –º–æ–¥—É–ª–∏     # dp.include_router(admin.router)      # –£–¥–∞–ª—è–µ–º –≤–µ–±—Ö—É–∫ –∏ –∑–∞–ø—É—Å–∫–∞–µ–º polling     await bot.delete_webhook(drop_pending_updates=True)     try:         await dp.start_polling(bot)     finally:         await bot.session.close()  if __name__ == "__main__":     try:         asyncio.run(main())     except (KeyboardInterrupt, SystemExit):         logger.info("Bot stopped!")`
    

IGNORE_WHEN_COPYING_START

Use code [with caution](https://support.google.com/legal/answer/13505487). Python

IGNORE_WHEN_COPYING_END

**6. –§–∞–π–ª app/middlewares/db.py (–∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω–∞—è —á–∞—Å—Ç—å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ë–î):**

      `from typing import Callable, Dict, Any, Awaitable from aiogram import BaseMiddleware from aiogram.types import TelegramObject from sqlalchemy.ext.asyncio import async_sessionmaker  class DbSessionMiddleware(BaseMiddleware):     def __init__(self, session_pool: async_sessionmaker):         super().__init__()         self.session_pool = session_pool      async def __call__(         self,         handler: Callable[[TelegramObject, Dict[str, Any]], Awaitable[Any]],         event: TelegramObject,         data: Dict[str, Any],     ) -> Any:         async with self.session_pool() as session:             data["session"] = session             return await handler(event, data)`
    

IGNORE_WHEN_COPYING_START

Use code [with caution](https://support.google.com/legal/answer/13505487). Python

IGNORE_WHEN_COPYING_END

### –ß—Ç–æ –î–µ–ª–∞—Ç—å –î–∞–ª—å—à–µ?

1. **–ù–∞—Å—Ç—Ä–æ–π—Ç–µ –û–∫—Ä—É–∂–µ–Ω–∏–µ:** –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ PostgreSQL, —Å–æ–∑–¥–∞–π—Ç–µ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ Python –∏ –≤—Å–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∫–æ–º–∞–Ω–¥–æ–π pip install -r requirements.txt.
    
2. **–ó–∞–ø–æ–ª–Ω–∏—Ç–µ .env:** –í–ø–∏—à–∏—Ç–µ —Å–≤–æ–π —Ç–æ–∫–µ–Ω –±–æ—Ç–∞ –∏ —Å—Ç—Ä–æ–∫—É –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –≤–∞—à–µ–π –ë–î.
    
3. **–°–æ–∑–¥–∞–π—Ç–µ –¢–∞–±–ª–∏—Ü—ã:** –í—ã–ø–æ–ª–Ω–∏—Ç–µ SQL-—Å–∫—Ä–∏–ø—Ç –∏–∑ –ø—É–Ω–∫—Ç–∞ 1 –≤ –≤–∞—à–µ–π –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö.
    
4. **–ó–∞–ø—É—Å—Ç–∏—Ç–µ –ë–æ—Ç–∞:** python bot.py. –û—Ç–ø—Ä–∞–≤—å—Ç–µ –µ–º—É –∫–æ–º–∞–Ω–¥—É /start. –ï—Å–ª–∏ –≤—Å—ë –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ –ø—Ä–∞–≤–∏–ª—å–Ω–æ, –≤ –≤–∞—à–µ–π —Ç–∞–±–ª–∏—Ü–µ users –ø–æ—è–≤–∏—Ç—Å—è –Ω–æ–≤–∞—è –∑–∞–ø–∏—Å—å.
    
5. **–†–∞–∑–≤–∏–≤–∞–π—Ç–µ –ü—Ä–æ–µ–∫—Ç:** –¢–µ–ø–µ—Ä—å —É –≤–∞—Å –µ—Å—Ç—å –ø—Ä–æ—á–Ω—ã–π —Ñ—É–Ω–¥–∞–º–µ–Ω—Ç. –ü–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ —Ä–µ–∞–ª–∏–∑—É–π—Ç–µ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª:
    
    - –°–æ–∑–¥–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã –∏ —Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä–æ—Å—Ç–æ–π.
        
    - –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø—Ä–∏–≥–ª–∞—Å–∏—Ç–µ–ª—å–Ω—ã—Ö —Å—Å—ã–ª–æ–∫ (/invite).
        
    - –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Ö–æ–¥–∞ –ø–æ —Å—Å—ã–ª–∫–µ (/start <token>).
        
    - –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞–ª–µ–Ω–¥–∞—Ä—è –∏ —Å–æ–±—ã—Ç–∏–π.
        

–≠—Ç–æ—Ç –ø–æ–¥—Ö–æ–¥ –ø–æ–∑–≤–æ–ª–∏—Ç –≤–∞–º —Å—Ç—Ä–æ–∏—Ç—å —Å–ª–æ–∂–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –ø–æ—ç—Ç–∞–ø–Ω–æ, —Å–æ—Ö—Ä–∞–Ω—è—è –ø–æ—Ä—è–¥–æ–∫ –≤ –∫–æ–¥–µ. –ï—Å–ª–∏ –±—É–¥—É—Ç –≤–æ–ø—Ä–æ—Å—ã –ø–æ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π —Ñ–∏—á–∏ ‚Äî —Å–ø—Ä–∞—à–∏–≤–∞–π—Ç–µ